#!/usr/bin/python3
import socket
import locale
import datetime
from pathlib import Path
import distro
import subprocess
import sys
import os
import json
from PyQt6.QtCore import QSize, Qt
from PyQt6.QtWidgets import QApplication, QMainWindow, QPushButton, QWidget, QVBoxLayout, QLabel, QHBoxLayout, QTabWidget, QMessageBox, QFileDialog, QColorDialog, QComboBox, QLineEdit, QListWidget, QBoxLayout

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()

        self.setWindowTitle("ZSysConf")

        self.welcome_tab_label = QLabel("Welcome to ZSysConf. Press any tab you like to configure.")
        self.welcome_tab_label.setWordWrap(1)

        self.welcome_tab_layout = QVBoxLayout()
        self.welcome_tab_layout.addWidget(self.welcome_tab_label)
        self.welcome_tab_layout.addStretch(1)

        self.welcome_tab = QWidget()
        self.welcome_tab.setLayout(self.welcome_tab_layout)

        self.about_tab_label = QLabel("Running on " + distro.name() + " " + distro.version() + "\n\nZDE is Wayland-based remix of deprecated EblanDE, that aims to look fresh and beautiful\n\nZSysConf is utility that aims to configure entire system (especially PizdOS) in ZConfig style.")
        self.about_tab_label.setWordWrap(1)

        self.about_tab_layout = QVBoxLayout()
        self.about_tab_layout.addWidget(self.about_tab_label)
        self.about_tab_layout.addStretch(1)

        self.about_tab = QWidget()
        self.about_tab.setLayout(self.about_tab_layout)

        self.timezone_tab_timezones = QComboBox()
        self.notintimezones = ["SECURITY", "tzdata.zi", "leap-seconds.list", "leapseconds"]
        for i in Path("/usr/share/zoneinfo").rglob("*"):
            if i.is_file() and not str(i).endswith(".tab") and not str(i.relative_to(Path("/usr/share/zoneinfo"))) in self.notintimezones:
                self.timezone_tab_timezones.addItem(str(i.relative_to(Path("/usr/share/zoneinfo"))))
        self.timezone_tab_timezones.setCurrentText(str(Path("/etc/localtime").resolve().relative_to("/usr/share/zoneinfo")).strip())

        self.timezone_tab_apply = QPushButton("Apply")
        self.timezone_tab_apply.clicked.connect(self.timezone_apply)
        
        self.timezone_tab_layout = QVBoxLayout()
        self.timezone_tab_layout.addWidget(self.timezone_tab_timezones)
        self.timezone_tab_layout.addWidget(self.timezone_tab_apply)
        self.timezone_tab_layout.addStretch(1)

        self.timezone_tab = QWidget()
        self.timezone_tab.setLayout(self.timezone_tab_layout)

        self.locale_tab_locales = QComboBox()
        supported_locales = open("/usr/share/i18n/SUPPORTED").read()
        for i in supported_locales.split("\n")[:-1]:
            if self.locale_tab_locales.findText(i.split(" ")[0].split(".")[0]) == -1:
                self.locale_tab_locales.addItem(i.split(" ")[0].split(".")[0])
        self.locale_tab_locales.setCurrentText(locale.getlocale()[0])
        
        self.locale_tab_apply = QPushButton("Apply")
        self.locale_tab_apply.clicked.connect(self.locale_apply)

        self.locale_tab_layout = QVBoxLayout()
        self.locale_tab_layout.addWidget(self.locale_tab_locales)
        self.locale_tab_layout.addWidget(self.locale_tab_apply)
        self.locale_tab_layout.addStretch(1)

        self.locale_tab = QWidget()
        self.locale_tab.setLayout(self.locale_tab_layout)

        self.hostname_tab_line = QLineEdit()
        self.hostname_tab_line.setText(socket.gethostname())

        self.hostname_tab_apply = QPushButton("Apply")
        self.hostname_tab_apply.clicked.connect(self.hostname_apply)

        self.hostname_tab_layout = QVBoxLayout()
        self.hostname_tab_layout.addWidget(self.hostname_tab_line)
        self.hostname_tab_layout.addWidget(self.hostname_tab_apply)
        self.hostname_tab_layout.addStretch(1)

        self.hostname_tab = QWidget()
        self.hostname_tab.setLayout(self.hostname_tab_layout)
        
        self.tab_container = QTabWidget()
        self.tab_container.addTab(self.welcome_tab, "Welcome") # ДОЛЖЕН БЫТЬПЕРВЫМ!!!!!!!
        self.tab_container.addTab(self.timezone_tab, "Timezone")
        self.tab_container.addTab(self.locale_tab, "Locale")
        self.tab_container.addTab(self.hostname_tab, "Hostname")
        self.tab_container.addTab(self.about_tab, "About") # ДОЛЭЕН БЫТЬ ПОСЛЕДНИМ!!!!!!!

        self.setCentralWidget(self.tab_container)
    def timezone_apply(self):
        print("APPLYING TIMEZONE SETTINGS!")
        print("Timezone: " + self.timezone_tab_timezones.currentText())
        print("===")
        print("Removing old timezone settings...")
        os.remove("/etc/localtime")
        print("Symlinking new timezone settings...")
        os.symlink("/usr/share/zoneinfo/" + self.timezone_tab_timezones.currentText(), "/etc/localtime")
        print("Applying...")
        subprocess.run(["hwclock", "--systohc"])
        QMessageBox.information(self, "OK", "Successful!")
    def locale_apply(self):
        print("APPLYING LOCALE SETTINGS!")
        print("Locale: " + self.locale_tab_locales.currentText())
        print("===")
        print("Modifying /etc/locale.gen...")
        localegen_file = open("/etc/locale.gen", "w")
        localegen_file.write("en_US.UTF-8 UTF-8\n" + self.locale_tab_locales.currentText() + ".UTF-8 UTF-8\n")
        localegen_file.close()
        print("Generating locales...")
        subprocess.run(["locale-gen"])
        print("Setting locale...")
        localeconf_file = open("/etc/locale.conf", "w")
        localeconf_file.write(str("LANG=" + self.locale_tab_locales.currentText() + ".UTF-8\nLC_ALL=" + self.locale_tab_locales.currentText() + ".UTF-8").strip())
        localeconf_file.close()
        QMessageBox.information(self, "OK", "Successful!")
    def hostname_apply(self):
        print("APPLYING HOSTNAME SETTINGS!")
        print("Hostname: " + self.hostname_tab_line.text())
        print("===")
        print("Setting hostname...")
        subprocess.run(["hostnamectl", "set-hostname", self.hostname_tab_line.text()])
        QMessageBox.information(self, "OK", "Successful!")

if os.geteuid() == 0:
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    app.exec()
else:
    print("You must be superuser.")
